import { Injectable } from '@nestjs/common';

@Injectable()
export class ResponseFormatterService {
  private escapeMarkdown(text: string): string {
    return text?.toString().replace(/([_*\[\]()~`>#+\-=|{}.!])/g, '\\$1') || '';
  }

  private createFoursquareUrl(venueId: string): string {
    return `https://foursquare.com/v/${venueId}`;
  }

  formatVenueList(data: any): { text: string; keyboard?: any } {
    if (!data.venues || !Array.isArray(data.venues)) {
      return { text: 'No venues found.' };
    }

    let text = `ğŸ¯ *Found ${data.total || data.venues.length} Amazing Places*\n`;
    text += `ğŸ” Searching: "${this.escapeMarkdown(data.query || '')}"\n\n`;
    
    // Create inline keyboard for venue selection
    const keyboard = {
      inline_keyboard: []
    };

    data.venues.forEach((venue, index) => {
      // Header with name and rating
      text += `${index + 1}. *${this.escapeMarkdown(venue.name)}*`;
      if (venue.rating !== 'No rating') {
        text += ` â­ ${this.escapeMarkdown(venue.rating)}`;
      }
      text += '\n';
      
      // Location and category
      text += `ğŸ“ ${this.escapeMarkdown(venue.address || 'Address not available')}\n`;
      text += `ğŸ·ï¸ ${this.escapeMarkdown(venue.category || 'Category not available')}`;
      
      // Price and distance
      let details = [];
      if (venue.price !== 'Price not available') {
        details.push(`ğŸ’° ${this.escapeMarkdown(venue.price)}`);
      }
      if (venue.distance) {
        details.push(`ğŸ“ ${this.escapeMarkdown(venue.distance)}`);
      }
      if (details.length > 0) {
        text += `\n${details.join(' â€¢ ')}`;
      }
      
      // Opening hours if available
      if (venue.hours?.display) {
        text += `\nğŸ•’ ${this.escapeMarkdown(venue.hours.display)}`;
      }

      // Add "View Details" button for this venue
      keyboard.inline_keyboard.push([
        {
          text: `ğŸ“ View ${venue.name}`,
          callback_data: `venue_${venue.fsq_id}`
        }
      ]);
      
      text += '\n\n';
    });

    text += 'ğŸ’¡ *Click the buttons below to view venue details*\n';
    text += 'Or type a number (1-' + data.venues.length + ') for quick selection';

    return { text, keyboard };
  }

  formatVenueDetails(venue: any): { text: string; keyboard?: any } {
    let text = `ğŸª *${this.escapeMarkdown(venue.name)}*\n\n`;
    
    // Main details
    text += `ğŸ“ *Location:* ${this.escapeMarkdown(venue.address || 'Address not available')}\n`;
    text += `ğŸ·ï¸ *Category:* ${this.escapeMarkdown(venue.category || 'Category not available')}\n`;
    
    // Ratings and Price section
    let ratings = [];
    if (venue.rating !== 'No rating') {
      ratings.push(`â­ Rating: ${this.escapeMarkdown(venue.rating)}`);
    }
    if (venue.price !== 'Price not available') {
      ratings.push(`ğŸ’° Price: ${this.escapeMarkdown(venue.price)}`);
    }
    if (ratings.length > 0) {
      text += `\n${ratings.join(' â€¢ ')}\n`;
    }
    
    // Hours and Distance
    if (venue.hours?.display) {
      text += `\nğŸ•’ *Hours:* ${this.escapeMarkdown(venue.hours.display)}\n`;
    }
    if (venue.distance) {
      text += `ğŸ“ *Distance:* ${this.escapeMarkdown(venue.distance)}\n`;
    }
    
    // Tips or Highlights if available
    if (venue.description) {
      text += `\nğŸ“ *Description:*\n${this.escapeMarkdown(venue.description)}\n`;
    }
    
    // Contact Info
    if (venue.tel) {
      text += `\nğŸ“ *Phone:* ${this.escapeMarkdown(venue.tel)}\n`;
    }
    if (venue.website) {
      text += `ğŸŒ *Website:* ${this.escapeMarkdown(venue.website)}\n`;
    }
    
    // Add Foursquare link
    if (venue.fsq_id) {
      text += `\nğŸ”— [View on Foursquare](${this.createFoursquareUrl(venue.fsq_id)})\n`;
    }

    // Create keyboard with useful actions
    const keyboard = {
      inline_keyboard: [
        [
          {
            text: 'ğŸ“ Open in Maps',
            url: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(venue.name + ' ' + (venue.address || ''))}`
          }
        ],
        [
          {
            text: 'ğŸ”™ Back to List',
            callback_data: 'back_to_venues'
          },
          {
            text: 'ğŸ“± Share Venue',
            callback_data: `share_venue_${venue.fsq_id}`
          }
        ]
      ]
    };

    return { text, keyboard };
  }

  formatToolResult(result: any): { text: string; keyboard?: any } {
    if (!result.success) {
      return this.formatError(result.result);
    }

    let data = result.result;
    if (typeof data === 'string') {
      try {
        data = JSON.parse(data);
      } catch (e) {
        return { text: data };
      }
    }

    if (data.venues) {
      return this.formatVenueList(data);
    }

    return {
      text: typeof data === 'string' ? data : JSON.stringify(data, null, 2)
    };
  }

  formatError(error: string): { text: string } {
    return {
      text: `âŒ Error: ${this.escapeMarkdown(error)}`
    };
  }
}
